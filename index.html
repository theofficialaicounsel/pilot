<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ai-Ndraft Pro</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- External Libraries (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/responsivevoice@1.0.0/responsivevoice.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

    <!-- Top Bar -->
    <div id="topBar">
        <div style="display:flex; align-items:center; gap: 8px; pointer-events: auto;">
            <button class="fab" id="undoFabTop" title="Undo"><i class="fas fa-undo"></i></button>
            <div id="brandPlaceholder">ai-Ndraft Pro</div>
        </div>
        <div class="top-fabs">
            <button class="fab" id="menuFab" title="Menu (Import/Export)"><i class="fas fa-bars"></i></button>
        </div>
    </div>

    <!-- Selection Bar -->
    <div id="selectionBar">
        <div>
            <button id="cancelSelect" class="btn btn-ghost" style="border:none;"><i class="fas fa-times"></i></button>
            <span id="selectCount" style="margin-left:10px; font-weight:600;">0</span>
        </div>
        <div>
            <button id="splitSelected" title="Split"><i class="fas fa-cut"></i></button>
            <button id="mergeSelected" title="Merge"><i class="fas fa-layer-group"></i></button>
            <button id="deleteSelected" title="Delete"><i class="fas fa-trash"></i></button>
        </div>
    </div>

    <!-- Fullscreen Overlay -->
    <div class="fullscreen-overlay" id="fullscreenOverlay">
        <div class="fs-header">
            <div style="display:flex; gap:8px;">
                <button class="btn btn-ghost" onclick="app.toggleFullscreenFlip()"><i class="fas fa-sync-alt"></i> Flip</button>
                <button class="btn btn-ghost" onclick="app.toggleNativeFullscreen()"><i class="fas fa-expand"></i> Native</button>
            </div>
            <div style="display:flex; gap:8px;">
                 <button class="btn btn-ghost" onclick="app.readCurrentFullscreen()"><i class="fas fa-volume-up"></i></button>
                 <button class="btn btn-ghost" onclick="app.closeFullscreen()"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="fs-content" id="fsContent">
            <!-- Request Pane (Optional, usually hidden in single view, but available if flipped) -->
            <div class="fs-pane" id="fsRequestPane" style="display:none;">
                <h3>Request</h3>
                <div id="fsRequest"></div>
            </div>
            <!-- Response Pane (Main) -->
            <div class="fs-pane" id="fsResponsePane">
                <h3>Response</h3>
                <div id="fsResponse"></div>
            </div>
        </div>
    </div>

    <!-- Grid Area -->
    <!-- Added tabindex for keyboard navigation -->
    <div id="grid" tabindex="0">
        <div id="emptyState">
            <h3>Start Creating</h3>
            <p>Type below to ask the AI.</p>
            <div style="margin-top: 20px; opacity: 0.6; font-size: 0.9em;">
                <i class="fas fa-hand-pointer"></i> Tap cards to flip<br>
                <i class="fas fa-fingerprint"></i> Long press for menu<br>
                <i class="fas fa-magic"></i> Use <code>!theme:...</code> in AI responses
            </div>
        </div>
    </div>

    <!-- View Button (Bottom Right) -->
    <div class="view-fab-container">
        <button class="fab primary" id="viewFab" title="View: List/Grid/Full"><i class="fas fa-columns"></i></button>
    </div>

    <!-- Input Panel -->
    <div id="inputPanel">
        <input type="text" id="userInput" placeholder="Type or say something..." autocomplete="off" spellcheck="false">
        <button id="sendBtn" title="Send">‚èé</button>
    </div>

    <!-- Card Context Menu -->
    <div id="cardMenu">
        <button class="menu-item" data-action="continue"><i class="fas fa-redo"></i> Continue</button>
        <button class="menu-item" data-action="split"><i class="fas fa-cut"></i> Split</button>
        <button class="menu-item" data-action="merge"><i class="fas fa-layer-group"></i> Merge</button>
        <button class="menu-item" data-action="ai-edit"><i class="fas fa-magic"></i> AI Edit</button>
        <div class="menu-separator"></div>
        <button class="menu-item" data-action="ai-theme"><i class="fas fa-palette"></i> AI Theme</button>
        <button class="menu-item" data-action="style"><i class="fas fa-paint-brush"></i> Manual Style</button>
        <div class="menu-separator"></div>
        <button class="menu-item" data-action="copy"><i class="fas fa-copy"></i> Copy</button>
        <button class="menu-item" data-action="fullscreen"><i class="fas fa-expand"></i> Fullscreen</button>
        <button class="menu-item" data-action="undo"><i class="fas fa-undo"></i> Undo</button>
        <div class="menu-separator"></div>
        <button class="menu-item" data-action="delete"><i class="fas fa-trash"></i> Delete</button>
    </div>

    <!-- Modals -->

    <!-- 1. Main Menu (Import/Export/Settings) -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Settings & Menu</h3>
                <button class="btn btn-ghost" onclick="app.closeModal('settingsModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                
                <div class="style-section">
                    <h4>API Configuration</h4>
                    <input type="text" id="proxyUrlInput" placeholder="Proxy URL (Default provided)" style="width:100%; margin-bottom:8px;">
                    <small style="color:var(--text); opacity:0.7;">Leave empty to use default proxy. Add your own Cloudflare/OpenAI endpoint URL.</small>
                </div>

                <div class="style-section">
                    <h4>Data Management</h4>
                    <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 16px;">
                        <button class="btn btn-primary" onclick="app.exportData()"><i class="fas fa-download"></i> Export</button>
                        <button class="btn btn-ghost" onclick="document.getElementById('fileInput').click()"><i class="fas fa-upload"></i> Import</button>
                        <input type="file" id="fileInput" style="display:none;" accept=".json" onchange="app.importData(this)">
                    </div>
                    <button class="btn btn-danger" onclick="app.clearAll()"><i class="fas fa-trash-alt"></i> Clear All Cards</button>
                </div>

                <div class="style-section">
                    <h4>Theme & View</h4>
                    <div class="toggle-group" style="margin-bottom:10px;">
                        <button class="toggle-btn" onclick="app.toggleThemeMode()">Toggle Light/Dark</button>
                        <button class="toggle-btn" onclick="app.toggleThemeLock()">
                            <i class="fas fa-lock"></i> <span id="lockLabel">Lock Theme</span>
                        </button>
                    </div>
                    <div class="toggle-group">
                        <button class="toggle-btn" onclick="app.setCardView('list')">List</button>
                        <button class="toggle-btn" onclick="app.setCardView('grid')">Grid</button>
                        <button class="toggle-btn" onclick="app.setCardView('full')">Fullscreen</button>
                    </div>
                </div>

                <div class="style-section">
                    <h4>Voice</h4>
                    <div class="toggle-group">
                        <button class="toggle-btn" id="asrToggle" onclick="app.toggleASR()">ASR (Mic)</button>
                        <button class="toggle-btn" id="ttsToggle" onclick="app.toggleTTS()">Auto TTS</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. Text Editor -->
    <div class="modal-overlay" id="textEditorModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="editorTitle">Edit Text</h3>
                <button class="btn btn-ghost" onclick="app.closeModal('textEditorModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <textarea id="textEditorArea"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="app.closeModal('textEditorModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveManualEdit()">Save</button>
            </div>
        </div>
    </div>

    <!-- 3. Prompt Modal -->
    <div class="modal-overlay" id="promptModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="promptTitle">Action</h3>
                <button class="btn btn-ghost" onclick="app.closeModal('promptModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p id="promptDesc" style="margin-bottom:8px; font-size:13px; opacity:0.8;"></p>
                <textarea id="promptArea" placeholder="Optional instructions..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="app.closeModal('promptModal')">Cancel</button>
                <button class="btn btn-primary" id="promptConfirmBtn">Execute</button>
            </div>
        </div>
    </div>

    <!-- 4. AI Theme Modal -->
    <div class="modal-overlay" id="aiThemeModal">
        <div class="modal">
            <div class="modal-header">
                <h3>AI Stylist</h3>
                <button class="btn btn-ghost" onclick="app.closeModal('aiThemeModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:8px; font-size:13px; opacity:0.8;">Describe the vibe (e.g., "Cyberpunk", "Vintage Paper").</p>
                <textarea id="aiThemePrompt" placeholder="Kill Bill red, pale text..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="app.closeModal('aiThemeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.applyAITheme()">Generate & Apply</button>
            </div>
        </div>
    </div>

    <!-- 5. Style Editor -->
    <div class="modal-overlay" id="styleModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Card Styles</h3>
                <button class="btn btn-ghost" onclick="app.closeModal('styleModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="lock-checkbox">
                    <input type="checkbox" id="styleLocked">
                    <label for="styleLocked">Lock Card Style (Protect from AI)</label>
                </div>

                <div class="style-section">
                    <h4>Text Style</h4>
                    <div class="toggle-group">
                        <button class="toggle-btn" data-style-prop="fontWeight" data-style-val="bold">Bold</button>
                        <button class="toggle-btn" data-style-prop="fontStyle" data-style-val="italic">Italic</button>
                        <button class="toggle-btn" data-style-prop="textDecoration" data-style-val="underline">Underline</button>
                    </div>
                </div>
                <div class="style-section">
                    <h4>Colors</h4>
                    <div class="color-picker"><label>Text</label><input type="color" id="styleColor" value="#f5f5f5"></div>
                    <div class="color-picker"><label>Background</label><input type="color" id="styleBg" value="#1e1e1e"></div>
                    <div class="color-picker"><label>Border</label><input type="color" id="styleBorder" value="#333333"></div>
                </div>
                <div class="style-section">
                    <h4>Dimensions</h4>
                    <div class="slider-group"><label style="width:80px;">Padding</label><input type="range" id="stylePadding" min="4" max="40" value="16"><span id="valPad">16px</span></div>
                    <div class="slider-group"><label style="width:80px;">Radius</label><input type="range" id="styleRadius" min="0" max="24" value="16"><span id="valRad">16px</span></div>
                    <div class="slider-group"><label style="width:80px;">Border W</label><input type="range" id="styleWidth" min="0" max="4" value="1"><span id="valWid">1px</span></div>
                </div>
                <div class="style-section">
                    <h4>Custom CSS (Scoped)</h4>
                    <textarea id="styleCustom" style="min-height:60px; font-family:monospace;" placeholder="e.g., h1 { color: red; }"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="app.closeModal('styleModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveStyles()">Apply Styles</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast">Action Saved</div>

    <!-- Main Application Script -->
    <script src="script.js"></script>
</body>
</html>