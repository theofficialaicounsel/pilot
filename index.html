<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>AI Mind Map</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg:#0a0a0a;--glass:rgba(26,26,26,0.8);--yellow:#ffd700;--text:#fff;--border:rgba(255,215,0,0.3)}
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}
        .header{position:fixed;top:0;left:0;right:0;height:50px;background:rgba(10,10,10,0.95);border-bottom:2px solid var(--yellow);padding:0 12px;display:flex;justify-content:space-between;align-items:center;z-index:1000}
        .logo{font-size:1.1rem;font-weight:bold;color:var(--yellow)}
        button{background:var(--glass);color:var(--yellow);border:1px solid var(--border);padding:8px 12px;border-radius:6px;cursor:pointer}
        .container{position:fixed;top:50px;left:0;right:0;bottom:0;display:flex;flex-direction:column}
        .input-panel{background:rgba(10,10,10,0.95);border-bottom:2px solid var(--yellow);padding:12px;flex-shrink:0}
        .section{margin-bottom:12px}
        .section-title{font-size:.75rem;color:var(--yellow);margin-bottom:8px;text-transform:uppercase}
        select,textarea,input{width:100%;background:var(--glass);color:var(--text);border:1px solid var(--border);padding:8px;border-radius:6px;font-size:16px}
        textarea{min-height:80px}
        .send-btn{width:100%;background:var(--yellow);color:var(--bg);border:none;padding:12px;font-weight:bold;margin-top:8px;cursor:pointer}
        .file-btn{margin-top:8px;background:var(--glass);color:var(--yellow);border:1px solid var(--border);padding:10px;border-radius:6px;text-align:center;cursor:pointer}
        .canvas{flex:1;overflow:hidden}
        .grid{display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(2,1fr);gap:0;width:100%;height:100%;overflow-y:auto}
        .flip-card{position:relative;width:100%;height:100%;min-height:0;cursor:pointer;perspective:1000px;overflow:hidden;background:var(--bg)}
        .flip-card-inner{position:relative;width:100%;height:100%;transition:transform .6s;transform-style:preserve-3d}
        .flip-card.flipped .flip-card-inner{transform:rotateY(180deg)}
        .card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;display:flex;flex-direction:column;background:var(--glass);backdrop-filter:blur(10px);border:2px solid var(--border);padding:8px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,.5);font-size:.65rem;line-height:1.2;font-family:monospace}
        .card-front{background:linear-gradient(135deg,rgba(255,215,0,.2),rgba(255,215,0,.1));border-left:4px solid var(--yellow)}
        .card-back{transform:rotateY(180deg);background:linear-gradient(135deg,rgba(100,150,255,.15),rgba(100,150,255,.05));border-left:4px solid #58a6ff}
        .response-content{flex:1;overflow:auto;display:flex;flex-direction:column;justify-content:center;align-items:center}
        .response-content img,.response-content video{max-width:100%;max-height:100%;object-fit:contain;border-radius:6px}
        .card-btn{background:rgba(0,0,0,.5);border:none;color:var(--text);font-size:.9rem;cursor:pointer;padding:4px 8px;border-radius:3px;margin:4px}
        .card-btn:hover{background:var(--yellow);color:var(--bg)}
        .card-actions{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:2000;align-items:center;justify-content:center;padding:20px}
        .modal.show{display:flex}
        .modal-content{background:rgba(26,26,26,.95);border:2px solid var(--yellow);border-radius:12px;padding:20px;max-width:500px;width:100%}
        .modal-title{font-size:1.2rem;color:var(--yellow);margin-bottom:16px}
        .loading{position:fixed;bottom:20px;right:20px;background:var(--glass);border:1px solid var(--yellow);padding:12px 20px;border-radius:8px;display:none;z-index:999}
        .loading.show{display:block}
        .saved-notice{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,255,0,.2);color:#0f0;border:1px solid #0f0;padding:10px 20px;border-radius:8px;z-index:999;opacity:0;transition:opacity .5s}
        .saved-notice.show{opacity:1}
        .settings-tools{display:flex;gap:10px;margin-top:20px}
        .settings-tools button,.settings-tools label{flex:1;background:var(--glass);color:var(--yellow);border:1px solid var(--border);padding:10px;border-radius:6px;cursor:pointer;text-align:center}
        .settings-tools input[type=file]{display:none}
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">AI Mind Map</div>
        <button onclick="showSettings()">Settings</button>
    </div>

    <div class="container">
        <div class="input-panel">
            <div class="section">
                <div class="section-title">Mode</div>
                <select id="modeSelect">
                    <option value="chat">Chat</option>
                    <option value="code">Code</option>
                    <option value="generate">Generate</option>
                </select>
            </div>
            <div class="section">
                <div class="section-title">Message / URL / File</div>
                <textarea id="userInput" placeholder="Ask AI, paste URL, or use button below..."></textarea>
                <div class="file-btn" onclick="document.getElementById('fileInput').click()">Upload Image/Video</div>
                <input type="file" id="fileInput" accept="image/*,video/*" style="display:none" onchange="handleFile(event)">
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>
        <div class="canvas"><div class="grid" id="grid"></div></div>
    </div>

    <div class="saved-notice" id="savedNotice">Saved!</div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-title">Settings</div>
            <div class="section"><div class="section-title">API Base URL</div><input type="text" id="baseUrl" placeholder="https://your-worker.workers.dev"></div>
            <div class="settings-tools">
                <button onclick="exportData()">Export Mind Map</button>
                <label for="importFile">Import Mind Map</label>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
                <button onclick="closeSettings()">Cancel</button>
                <button class="send-btn" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">Processing...</div>

    <script>
        let pairs = [];
        const sessionHistory = {};

        async function apiFetch(path, payload) {
            const base = document.getElementById("baseUrl").value.trim().replace(/\/+$/, '');
            const url = base + path;
            try {
                const res = await fetch(url, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
                const text = await res.text();
                let data;
                try {data = JSON.parse(text)} catch {data = text}
                return {ok:res.ok, data};
            } catch {return {ok:false, data:{error:"Network error"}}}
        }

        function isMediaUrl(str) {return /\.(jpg|jpeg|png|gif|webp|mp4|webm|mov|mkv|avi)(\?.*)?$/i.test(str.trim())}
        function createMediaTile(src) {
            const isVideo = src.match(/\.(mp4|webm|mov|mkv|avi)/i);
            return isVideo
                ? `<video controls autoplay loop muted playsinline><source src="${src}"></video>`
                : `<img src="${src}" alt="Media">`;
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                const dataUrl = ev.target.result;
                addPair({question:"Local Media", response:`<div class="response-content">${createMediaTile(dataUrl)}</div>`, sessionId: ""});
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        }

        async function sendMessage() {
            let input = document.getElementById("userInput").value.trim();
            if (!input) return;
            const mode = document.getElementById("modeSelect").value;

            if (isMediaUrl(input)) {
                addPair({question:"Media URL", response:`<div class="response-content">${createMediaTile(input)}</div>`, sessionId: ""});
                document.getElementById("userInput").value = '';
                return;
            }

            const lines = input.split('\n');
            const tiles = [];
            let current = '';
            for (const line of lines) {
                if (line.trim() === '---' && current.trim()) {
                    tiles.push(current.trim());
                    current = '';
                } else current += line + '\n';
            }
            if (current.trim()) tiles.push(current.trim());

            for (let i = 0; i < tiles.length; i++) {
                const text = tiles[i];
                const isLast = i === tiles.length - 1;
                const sessionId = Date.now() + "-" + i;
                addPair({question:text, response:'Processing...', sessionId});
                if (isLast) await sendToAI(text, sessionId, mode);
            }
            document.getElementById("userInput").value = '';
        }

        async function sendToAI(text, sessionId, mode) {
            document.getElementById("loading").classList.add("show");
            try {
                const base = document.getElementById("baseUrl").value.trim();
                if (!base) {updateLastPair({response:'Set API URL!', sessionId}); return}

                const history = sessionHistory[sessionId] || [];
                const messages = [...history, {role:"user", content:text}];

                const payload = mode==='code'
                    ? {prompt:text, messages}
                    : mode==='generate'
                    ? {prompt:text, format:"text", messages}
                    : {message:text, messages, sessionId};

                const path = mode==='code' ? '/api/code' : mode==='generate' ? '/api/generate' : '/api/chat';

                const res = await apiFetch(path, payload);
                if (!res.ok) {updateLastPair({response:`HTTP ${res.status||'Error'}`, sessionId}); return}

                let reply = '';
                if (typeof res.data === 'string') reply = res.data;
                else if (res.data.response) reply = res.data.response;
                else if (res.data.message) reply = res.data.message;
                else if (res.data.code) reply = res.data.code;
                else reply = JSON.stringify(res.data, null, 2);

                const formatted = (mode==='code' || res.data.code)
                    ? `<pre><code>${reply.trim()}</code></pre>`
                    : reply;

                updateLastPair({response:formatted, sessionId});
                sessionHistory[sessionId] = [...messages, {role:"assistant", content:reply}];

            } catch {updateLastPair({response:'Failed', sessionId})}
            finally {document.getElementById("loading").classList.remove("show")}
        }

        function sendTileToAI(id) {
            const tile = pairs.find(p => p.id === id);
            if (!tile) return;
            const cleanText = tile.question.replace(/<[^>]*>/g, '');
            addPair({question:`â†’ ${cleanText}`, response:'Processing...', sessionId:tile.sessionId || ""});
            sendToAI(cleanText, tile.sessionId || Date.now().toString(), document.getElementById("modeSelect").value);
        }

        function addPair(p){
            const id=Date.now()+Math.random();
            pairs.push({id,question:p.question,response:p.response,sessionId:p.sessionId||""});
            renderPair(pairs[pairs.length-1]);
            save();
        }
        function updateLastPair(u){
            if(pairs.length>0){
                const last=pairs[pairs.length-1];
                Object.assign(last,u);
                const c=document.querySelector(`[data-id="${last.id}"]`);
                if(c) c.querySelector('.response-content').innerHTML=u.response;
                save();
            }
        }
        function renderPair(p){
            const g=document.getElementById("grid");
            const c=document.createElement("div");c.className="flip-card";c.dataset.id=p.id;
            c.innerHTML=`
                <div class="flip-card-inner">
                    <div class="card-face card-front"><div style="flex:1;overflow:auto">${p.question}</div>
                        <div class="card-actions">
                            <button class="card-btn" onclick="deletePair(${p.id})">Delete</button>
                            <button class="card-btn" onclick="sendTileToAI(${p.id})">Send to AI</button>
                        </div>
                    </div>
                    <div class="card-face card-back"><div class="response-content" style="flex:1;overflow:auto">${p.response}</div>
                        <button class="card-btn" onclick="copyResponse(${p.id})">Copy</button>
                    </div>
                </div>`;
            c.onclick=e=>{if(e.target.closest('.card-btn'))return;c.classList.toggle('flipped')};
            g.appendChild(c);
        }
        function deletePair(id){pairs=pairs.filter(p=>p.id!==id);document.querySelector(`[data-id="${id}"]`)?.remove();save()}
        function copyResponse(id){const p=pairs.find(x=>x.id===id);if(p){const t=document.createElement('div');t.innerHTML=p.response;navigator.clipboard.writeText(t.textContent||'');alert('Copied!')}}
        function exportData(){const data={pairs,sessionHistory};const b=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});const u=URL.createObjectURL(b);const a=document.createElement("a");a.href=u;a.download="mindmap-full.json";a.click();URL.revokeObjectURL(u)}
        function importData(e){
            const f=e.target.files[0];if(!f)return;
            const r=new FileReader();r.onload=x=>{
                try{
                    const d=JSON.parse(x.target.result);
                    pairs = d.pairs || [];
                    Object.assign(sessionHistory, d.sessionHistory || {});
                    document.getElementById("grid").innerHTML='';
                    pairs.forEach(renderPair);
                    save();alert('Imported!');
                }catch{alert('Bad file')}
            };
            r.readAsText(f);
        }
        function showSavedNotice(){const n=document.getElementById("savedNotice");n.classList.add("show");setTimeout(()=>n.classList.remove("show"),2000)}
        function showSettings(){document.getElementById("settingsModal").classList.add("show")}
        function closeSettings(){document.getElementById("settingsModal").classList.remove("show")}
        function saveSettings(){localStorage.setItem("mindmap-baseUrl",document.getElementById("baseUrl").value.trim());closeSettings();showSavedNotice()}
        function save(){localStorage.setItem("mindmap-data",JSON.stringify({pairs,sessionHistory}))}
        function load(){
            const saved=localStorage.getItem("mindmap-data");
            if(saved){
                const d=JSON.parse(saved);
                pairs=d.pairs||[];
                Object.assign(sessionHistory, d.sessionHistory||{});
                pairs.forEach(renderPair);
            }
            const url=localStorage.getItem("mindmap-baseUrl");
            if(url)document.getElementById("baseUrl").value=url;
        }
        document.getElementById("userInput").addEventListener("keypress",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendMessage()}})
        load();
    </script>
</body>
</html>